#!/bin/bash -x

PGPASSWORD=<%= node[:metroextractor][:postgres][:password] %>
OSMOPTS="--host <%= node[:hostname] %> --database <%= node[:metroextractor][:postgres][:db] %> --username <%= node[:metroextractor][:postgres][:user] %>"
PGSQLOPTS="-h <%= node[:hostname] %> -d <%= node[:metroextractor][:postgres][:db] %> -U <%= node[:metroextractor][:postgres][:user] %>"
PGSQL2SHPOPTS="-h <%= node[:hostname] %> -u <%= node[:metroextractor][:postgres][:user] %> -P <%= node[:metroextractor][:postgres][:password] %> <%= node[:metroextractor][:postgres][:db] %>"
export PGPASSWORD OSMOPTS PGSQLOPTS PGSQL2SHPOPTS

function osm2pgsql_shapefiles
{
    slug=$1
    prefix=${slug//-/_}_osm

    osm2pgsql -sluc -C 1024 ${OSMOPTS} -S <%= node[:metroextractor][:setup][:scriptsdir] %>/osm2pgsql.style -p ${prefix} ex/$slug.osm.bz2
    
    pgsql2shp -rk -f shp/$slug.osm-point.shp    ${PGSQL2SHPOPTS} ${prefix}_point
    pgsql2shp -rk -f shp/$slug.osm-polygon.shp  ${PGSQL2SHPOPTS} ${prefix}_polygon
    pgsql2shp -rk -f shp/$slug.osm-line.shp     ${PGSQL2SHPOPTS} ${prefix}_line

    zip -j shp/$slug.osm2pgsql-shapefiles.zip shp/$slug.osm-*.shp shp/$slug.osm-*.prj shp/$slug.osm-*.dbf shp/$slug.osm-*.shx

    rm shp/$slug.osm-*.*
    
    echo "DROP TABLE ${prefix}_line"    | psql ${PGSQLOPTS}
    echo "DROP TABLE ${prefix}_nodes"   | psql ${PGSQLOPTS}
    echo "DROP TABLE ${prefix}_point"   | psql ${PGSQLOPTS}
    echo "DROP TABLE ${prefix}_polygon" | psql ${PGSQLOPTS}
    echo "DROP TABLE ${prefix}_rels"    | psql ${PGSQLOPTS}
    echo "DROP TABLE ${prefix}_roads"   | psql ${PGSQLOPTS}
    echo "DROP TABLE ${prefix}_ways"    | psql ${PGSQLOPTS}
}

function imposm_shapefiles
{
    slug=$1
    prefix=${slug//-/_}
    
    mkdir shp/$slug-imposm
    
    # "--connect" is an undocumented option for imposm; Olive Tonnhofer assures me it won't disappear in the future.
    imposm --read --cache-dir shp/$slug-imposm --write --table-prefix=${prefix}_ --connect postgis://<%= node[:metroextractor][:postgres][:user] %>:<%= node[:metroextractor][:postgres][:password] %>@<%= node[:hostname] %>/<%= node[:metroextractor][:postgres][:db] %> ex/$slug.osm.pbf

    pgsql2shp -rk -f shp/$slug-imposm/$slug.osm-admin.shp             ${PGSQL2SHPOPTS} ${prefix}_admin
    pgsql2shp -rk -f shp/$slug-imposm/$slug.osm-aeroways.shp          ${PGSQL2SHPOPTS} ${prefix}_aeroways
    pgsql2shp -rk -f shp/$slug-imposm/$slug.osm-amenities.shp         ${PGSQL2SHPOPTS} ${prefix}_amenities
    pgsql2shp -rk -f shp/$slug-imposm/$slug.osm-buildings.shp         ${PGSQL2SHPOPTS} ${prefix}_buildings
    pgsql2shp -rk -f shp/$slug-imposm/$slug.osm-landusages.shp        ${PGSQL2SHPOPTS} ${prefix}_landusages
    pgsql2shp -rk -f shp/$slug-imposm/$slug.osm-landusages_gen0.shp   ${PGSQL2SHPOPTS} ${prefix}_landusages_gen0
    pgsql2shp -rk -f shp/$slug-imposm/$slug.osm-landusages_gen1.shp   ${PGSQL2SHPOPTS} ${prefix}_landusages_gen1
    pgsql2shp -rk -f shp/$slug-imposm/$slug.osm-mainroads.shp         ${PGSQL2SHPOPTS} ${prefix}_mainroads
    pgsql2shp -rk -f shp/$slug-imposm/$slug.osm-mainroads_gen0.shp    ${PGSQL2SHPOPTS} ${prefix}_mainroads_gen0
    pgsql2shp -rk -f shp/$slug-imposm/$slug.osm-mainroads_gen1.shp    ${PGSQL2SHPOPTS} ${prefix}_mainroads_gen1
    pgsql2shp -rk -f shp/$slug-imposm/$slug.osm-minorroads.shp        ${PGSQL2SHPOPTS} ${prefix}_minorroads
    pgsql2shp -rk -f shp/$slug-imposm/$slug.osm-motorways.shp         ${PGSQL2SHPOPTS} ${prefix}_motorways
    pgsql2shp -rk -f shp/$slug-imposm/$slug.osm-motorways_gen0.shp    ${PGSQL2SHPOPTS} ${prefix}_motorways_gen0
    pgsql2shp -rk -f shp/$slug-imposm/$slug.osm-motorways_gen1.shp    ${PGSQL2SHPOPTS} ${prefix}_motorways_gen1
    pgsql2shp -rk -f shp/$slug-imposm/$slug.osm-places.shp            ${PGSQL2SHPOPTS} ${prefix}_places
    pgsql2shp -rk -f shp/$slug-imposm/$slug.osm-railways.shp          ${PGSQL2SHPOPTS} ${prefix}_railways
    pgsql2shp -rk -f shp/$slug-imposm/$slug.osm-railways_gen0.shp     ${PGSQL2SHPOPTS} ${prefix}_railways_gen0
    pgsql2shp -rk -f shp/$slug-imposm/$slug.osm-railways_gen1.shp     ${PGSQL2SHPOPTS} ${prefix}_railways_gen1
    pgsql2shp -rk -f shp/$slug-imposm/$slug.osm-roads.shp             ${PGSQL2SHPOPTS} ${prefix}_roads
    pgsql2shp -rk -f shp/$slug-imposm/$slug.osm-roads_gen0.shp        ${PGSQL2SHPOPTS} ${prefix}_roads_gen0
    pgsql2shp -rk -f shp/$slug-imposm/$slug.osm-roads_gen1.shp        ${PGSQL2SHPOPTS} ${prefix}_roads_gen1
    pgsql2shp -rk -f shp/$slug-imposm/$slug.osm-transport_areas.shp   ${PGSQL2SHPOPTS} ${prefix}_transport_areas
    pgsql2shp -rk -f shp/$slug-imposm/$slug.osm-transport_points.shp  ${PGSQL2SHPOPTS} ${prefix}_transport_points
    pgsql2shp -rk -f shp/$slug-imposm/$slug.osm-waterareas.shp        ${PGSQL2SHPOPTS} ${prefix}_waterareas
    pgsql2shp -rk -f shp/$slug-imposm/$slug.osm-waterareas_gen0.shp   ${PGSQL2SHPOPTS} ${prefix}_waterareas_gen0
    pgsql2shp -rk -f shp/$slug-imposm/$slug.osm-waterareas_gen1.shp   ${PGSQL2SHPOPTS} ${prefix}_waterareas_gen1
    pgsql2shp -rk -f shp/$slug-imposm/$slug.osm-waterways.shp         ${PGSQL2SHPOPTS} ${prefix}_waterways

    zip -j shp/$slug.imposm-shapefiles.zip shp/$slug-imposm/$slug.osm-*.shp shp/$slug-imposm/$slug.osm-*.prj shp/$slug-imposm/$slug.osm-*.dbf shp/$slug-imposm/$slug.osm-*.shx

    rm -r shp/$slug-imposm
    
    echo "DROP VIEW ${prefix}_roads"              | psql ${PGSQLOPTS}
    echo "DROP VIEW ${prefix}_roads_gen0"         | psql ${PGSQLOPTS}
    echo "DROP VIEW ${prefix}_roads_gen1"         | psql ${PGSQLOPTS}
    echo "DROP TABLE ${prefix}_admin"             | psql ${PGSQLOPTS}
    echo "DROP TABLE ${prefix}_aeroways"          | psql ${PGSQLOPTS}
    echo "DROP TABLE ${prefix}_amenities"         | psql ${PGSQLOPTS}
    echo "DROP TABLE ${prefix}_buildings"         | psql ${PGSQLOPTS}
    echo "DROP TABLE ${prefix}_landusages"        | psql ${PGSQLOPTS}
    echo "DROP TABLE ${prefix}_landusages_gen0"   | psql ${PGSQLOPTS}
    echo "DROP TABLE ${prefix}_landusages_gen1"   | psql ${PGSQLOPTS}
    echo "DROP TABLE ${prefix}_mainroads"         | psql ${PGSQLOPTS}
    echo "DROP TABLE ${prefix}_mainroads_gen0"    | psql ${PGSQLOPTS}
    echo "DROP TABLE ${prefix}_mainroads_gen1"    | psql ${PGSQLOPTS}
    echo "DROP TABLE ${prefix}_minorroads"        | psql ${PGSQLOPTS}
    echo "DROP TABLE ${prefix}_motorways"         | psql ${PGSQLOPTS}
    echo "DROP TABLE ${prefix}_motorways_gen0"    | psql ${PGSQLOPTS}
    echo "DROP TABLE ${prefix}_motorways_gen1"    | psql ${PGSQLOPTS}
    echo "DROP TABLE ${prefix}_places"            | psql ${PGSQLOPTS}
    echo "DROP TABLE ${prefix}_railways"          | psql ${PGSQLOPTS}
    echo "DROP TABLE ${prefix}_railways_gen0"     | psql ${PGSQLOPTS}
    echo "DROP TABLE ${prefix}_railways_gen1"     | psql ${PGSQLOPTS}
    echo "DROP TABLE ${prefix}_transport_areas"   | psql ${PGSQLOPTS}
    echo "DROP TABLE ${prefix}_transport_points"  | psql ${PGSQLOPTS}
    echo "DROP TABLE ${prefix}_waterareas"        | psql ${PGSQLOPTS}
    echo "DROP TABLE ${prefix}_waterareas_gen0"   | psql ${PGSQLOPTS}
    echo "DROP TABLE ${prefix}_waterareas_gen1"   | psql ${PGSQLOPTS}
    echo "DROP TABLE ${prefix}_waterways"         | psql ${PGSQLOPTS}
}

<% require 'json' %>
<% json = File.read("#{node[:metroextractor][:setup][:scriptsdir]}/cities.json") %>
<% data = JSON.parse(json) %>
<% data['regions'].each do |region, val| %>
  <% val['cities'].keys.each do |city| %>
osm2pgsql_shapefiles <%= city %> &
imposm_shapefiles <%= city %> &
wait
  <% end %>
<% end %>
