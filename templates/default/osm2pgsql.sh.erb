#!/bin/bash -x

# 
# This script expects to be run as the postgres user.
# 

function osm2pgsql_shapefiles
{
    slug=$1
    prefix=${slug//-/_}_osm

    osm2pgsql -sluc -C 1024 -d osm -S osm2pgsql.style -p ${prefix} <%= node[:metroextractor][:basedir] %>/ex/$slug.osm.bz2 > /dev/null 2>&1
    
    pgsql2shp -rk -f tmp/$slug.osm-point.shp osm ${prefix}_point
    pgsql2shp -rk -f tmp/$slug.osm-polygon.shp osm ${prefix}_polygon
    pgsql2shp -rk -f tmp/$slug.osm-line.shp osm ${prefix}_line
    zip -j tmp/$slug.osm2pgsql-shapefiles.zip tmp/$slug.osm-*.shp tmp/$slug.osm-*.prj tmp/$slug.osm-*.dbf tmp/$slug.osm-*.shx

    rm tmp/$slug.osm-*.*
    
    echo "DROP TABLE ${prefix}_line" | psql osm
    echo "DROP TABLE ${prefix}_nodes" | psql osm
    echo "DROP TABLE ${prefix}_point" | psql osm
    echo "DROP TABLE ${prefix}_polygon" | psql osm
    echo "DROP TABLE ${prefix}_rels" | psql osm
    echo "DROP TABLE ${prefix}_roads" | psql osm
    echo "DROP TABLE ${prefix}_ways" | psql osm
}

osm2pgsql_shapefiles abuja &
wait
osm2pgsql_shapefiles bejaia &
wait
osm2pgsql_shapefiles cairo &
wait
osm2pgsql_shapefiles dar-es-salaam &
wait
osm2pgsql_shapefiles harare &
wait
osm2pgsql_shapefiles johannesburg &
wait
osm2pgsql_shapefiles kampala &
wait
osm2pgsql_shapefiles lagos &
wait
osm2pgsql_shapefiles mogadishu &
wait
osm2pgsql_shapefiles nairobi &
wait
osm2pgsql_shapefiles kigali &
wait
osm2pgsql_shapefiles almaty &
wait
osm2pgsql_shapefiles ankara &
wait
osm2pgsql_shapefiles bangkok &
wait
osm2pgsql_shapefiles batticaloa &
wait
osm2pgsql_shapefiles beijing &
wait
osm2pgsql_shapefiles bengaluru &
wait
osm2pgsql_shapefiles chelyabinsk &
wait
osm2pgsql_shapefiles chengdu &
wait
osm2pgsql_shapefiles chennai &
wait
osm2pgsql_shapefiles chongqing &
wait
osm2pgsql_shapefiles dharamshala &
wait
osm2pgsql_shapefiles colombo &
wait
osm2pgsql_shapefiles dhaka &
wait
osm2pgsql_shapefiles dushanbe &
wait
osm2pgsql_shapefiles hong-kong &
wait
osm2pgsql_shapefiles islamabad &
wait
osm2pgsql_shapefiles kathmandu &
wait
osm2pgsql_shapefiles karachi &
wait
osm2pgsql_shapefiles kolkata &
wait
osm2pgsql_shapefiles lahore &
wait
osm2pgsql_shapefiles nazareth &
wait
osm2pgsql_shapefiles manila &
wait
osm2pgsql_shapefiles mumbai &
wait
osm2pgsql_shapefiles new-delhi &
wait
osm2pgsql_shapefiles osaka-kyoto &
wait
osm2pgsql_shapefiles pyongyang &
wait
osm2pgsql_shapefiles samarkand &
wait
osm2pgsql_shapefiles seoul &
wait
osm2pgsql_shapefiles siem-reap &
wait
osm2pgsql_shapefiles shanghai &
wait
osm2pgsql_shapefiles singapore &
wait
osm2pgsql_shapefiles taipei &
wait
osm2pgsql_shapefiles tehran &
wait
osm2pgsql_shapefiles tokyo &
wait
osm2pgsql_shapefiles amsterdam &
wait
osm2pgsql_shapefiles athens &
wait
osm2pgsql_shapefiles barcelona &
wait
osm2pgsql_shapefiles berlin &
wait
osm2pgsql_shapefiles bilbao &
wait
osm2pgsql_shapefiles birmingham &
wait
osm2pgsql_shapefiles bordeaux &
wait
osm2pgsql_shapefiles brno &
wait
osm2pgsql_shapefiles brussels &
wait
osm2pgsql_shapefiles bucharest &
wait
osm2pgsql_shapefiles budapest &
wait
osm2pgsql_shapefiles cantabria &
wait
osm2pgsql_shapefiles cardiff-newport-bristol-bath &
wait
osm2pgsql_shapefiles copenhagen &
wait
osm2pgsql_shapefiles colchester &
wait
osm2pgsql_shapefiles edinburgh &
wait
osm2pgsql_shapefiles florence &
wait
osm2pgsql_shapefiles frankfurt &
wait
osm2pgsql_shapefiles gdansk &
wait
osm2pgsql_shapefiles genoa &
wait
osm2pgsql_shapefiles gijon &
wait
osm2pgsql_shapefiles glasgow &
wait
osm2pgsql_shapefiles hamburg &
wait
osm2pgsql_shapefiles helsinki &
wait
osm2pgsql_shapefiles istanbul &
wait
osm2pgsql_shapefiles karlsruhe &
wait
osm2pgsql_shapefiles kirovograd &
wait
osm2pgsql_shapefiles krakow &
wait
osm2pgsql_shapefiles kyiv &
wait
osm2pgsql_shapefiles leeds &
wait
osm2pgsql_shapefiles lille &
wait
osm2pgsql_shapefiles lisbon &
wait
osm2pgsql_shapefiles lyon &
wait
osm2pgsql_shapefiles london &
wait
osm2pgsql_shapefiles lviv &
wait
osm2pgsql_shapefiles madrid &
wait
osm2pgsql_shapefiles manchester &
wait
osm2pgsql_shapefiles marseille &
wait
osm2pgsql_shapefiles milan &
wait
osm2pgsql_shapefiles monaco &
wait
osm2pgsql_shapefiles montpellier &
wait
osm2pgsql_shapefiles moscow &
wait
osm2pgsql_shapefiles munich &
wait
osm2pgsql_shapefiles nantes &
wait
osm2pgsql_shapefiles newcastle &
wait
osm2pgsql_shapefiles nuremberg &
wait
osm2pgsql_shapefiles odessa &
wait
osm2pgsql_shapefiles oslo &
wait
osm2pgsql_shapefiles palermo &
wait
osm2pgsql_shapefiles paris &
wait
osm2pgsql_shapefiles porto &
wait
osm2pgsql_shapefiles prague &
wait
osm2pgsql_shapefiles reykjavik &
wait
osm2pgsql_shapefiles riga &
wait
osm2pgsql_shapefiles rome &
wait
osm2pgsql_shapefiles rotterdam &
wait
osm2pgsql_shapefiles sarajevo &
wait
osm2pgsql_shapefiles sochi &
wait
osm2pgsql_shapefiles sofia &
wait
osm2pgsql_shapefiles stockholm &
wait
osm2pgsql_shapefiles strasbourg &
wait
osm2pgsql_shapefiles st-petersburg &
wait
osm2pgsql_shapefiles tampere &
wait
osm2pgsql_shapefiles toulouse &
wait
osm2pgsql_shapefiles samara-tolyatti &
wait
osm2pgsql_shapefiles vienna &
wait
osm2pgsql_shapefiles vienna-bratislava &
wait
osm2pgsql_shapefiles venice &
wait
osm2pgsql_shapefiles warsaw &
wait
osm2pgsql_shapefiles wroclaw &
wait
osm2pgsql_shapefiles as-suwayda &
wait
osm2pgsql_shapefiles baghdad &
wait
osm2pgsql_shapefiles damascus &
wait
osm2pgsql_shapefiles dubai-abu-dhabi &
wait
osm2pgsql_shapefiles kabul &
wait
osm2pgsql_shapefiles riyadh &
wait
osm2pgsql_shapefiles tel-aviv &
wait
osm2pgsql_shapefiles yerevan &
wait
osm2pgsql_shapefiles atlanta &
wait
osm2pgsql_shapefiles austin &
wait
osm2pgsql_shapefiles boston &
wait
osm2pgsql_shapefiles calgary &
wait
osm2pgsql_shapefiles charlotte &
wait
osm2pgsql_shapefiles chattanooga &
wait
osm2pgsql_shapefiles chicago &
wait
osm2pgsql_shapefiles cincinnati &
wait
osm2pgsql_shapefiles cleveland &
wait
osm2pgsql_shapefiles columbus-oh &
wait
osm2pgsql_shapefiles dallas &
wait
osm2pgsql_shapefiles denver-boulder &
wait
osm2pgsql_shapefiles detroit &
wait
osm2pgsql_shapefiles edmonton &
wait
osm2pgsql_shapefiles evansville &
wait
osm2pgsql_shapefiles grand-rapids-holland-muskegon &
wait
osm2pgsql_shapefiles grassvalley &
wait
osm2pgsql_shapefiles honolulu &
wait
osm2pgsql_shapefiles houston &
wait
osm2pgsql_shapefiles humboldt-ca &
wait
osm2pgsql_shapefiles indianapolis &
wait
osm2pgsql_shapefiles kamloops &
wait
osm2pgsql_shapefiles las-vegas &
wait
osm2pgsql_shapefiles kansas-city-lawrence-topeka &
wait
osm2pgsql_shapefiles lexington &
wait
osm2pgsql_shapefiles los-angeles &
wait
osm2pgsql_shapefiles macon-ga &
wait
osm2pgsql_shapefiles madison &
wait
osm2pgsql_shapefiles mexico-city &
wait
osm2pgsql_shapefiles miami &
wait
osm2pgsql_shapefiles milwaukee &
wait
osm2pgsql_shapefiles mpls-stpaul &
wait
osm2pgsql_shapefiles mobile-al &
wait
osm2pgsql_shapefiles montreal &
wait
osm2pgsql_shapefiles nashville &
wait
osm2pgsql_shapefiles new-orleans &
wait
osm2pgsql_shapefiles new-york &
wait
osm2pgsql_shapefiles philadelphia &
wait
osm2pgsql_shapefiles phoenix &
wait
osm2pgsql_shapefiles pittsburgh &
wait
osm2pgsql_shapefiles port-au-prince &
wait
osm2pgsql_shapefiles portland &
wait
osm2pgsql_shapefiles portland-me &
wait
osm2pgsql_shapefiles reno &
wait
osm2pgsql_shapefiles st-louis &
wait
osm2pgsql_shapefiles sacramento &
wait
osm2pgsql_shapefiles san-diego-tijuana &
wait
osm2pgsql_shapefiles san-francisco &
wait
osm2pgsql_shapefiles sf-bay-area &
wait
osm2pgsql_shapefiles santa-barbara &
wait
osm2pgsql_shapefiles santo-domingo &
wait
osm2pgsql_shapefiles seattle &
wait
osm2pgsql_shapefiles state-college-pa &
wait
osm2pgsql_shapefiles tampa &
wait
osm2pgsql_shapefiles terre-haute &
wait
osm2pgsql_shapefiles toronto &
wait
osm2pgsql_shapefiles tucson &
wait
osm2pgsql_shapefiles vancouver &
wait
osm2pgsql_shapefiles victoria &
wait
osm2pgsql_shapefiles dc-baltimore &
wait
osm2pgsql_shapefiles auckland &
wait
osm2pgsql_shapefiles jakarta &
wait
osm2pgsql_shapefiles canberra &
wait
osm2pgsql_shapefiles melbourne &
wait
osm2pgsql_shapefiles sydney &
wait
osm2pgsql_shapefiles bogota &
wait
osm2pgsql_shapefiles brasilia-brazil &
wait
osm2pgsql_shapefiles buenos-aires &
wait
osm2pgsql_shapefiles campo-grande &
wait
osm2pgsql_shapefiles cartagena &
wait
osm2pgsql_shapefiles curitiba-brazil &
wait
osm2pgsql_shapefiles lima &
wait
osm2pgsql_shapefiles porto-alegre &
wait
osm2pgsql_shapefiles quito-ecuador &
wait
osm2pgsql_shapefiles rio-de-janeiro &
wait
osm2pgsql_shapefiles sao-paulo &
wait
osm2pgsql_shapefiles santiago &
wait
osm2pgsql_shapefiles trinidad-tobago &
wait
